<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<title>Battle &middot; Code Kungfu</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description"
		content="Create your AI and duel with the other player.">
	<meta name="author" content="Indra Adam">
	
	<!-- Styles -->
	<link rel="stylesheet" href="./styles/bootstrap.css" >
    <link rel="stylesheet" href="./styles/bootstrap-responsive.min.css">
	<link rel="stylesheet" href="./styles/codemirror/codemirror.css">
    <link rel="icon" href="./img/favicon.png" type="image/png" />
	<style type="text/css">
		body {
	        padding-top: 40px;
	        padding-bottom: 0px;
	    }
		.CodeMirror {
			border: 1px solid black;
		}
		
		.CodeMirror-activeline-background {
			background: #e8f2ff !important;
		}
	</style>
	
</head>

<body>

<!-- FB Login Button -->
	<div id="fb-root"></div>
        <script type="text/javascript">
            var button;
            var signInButton;
            var signInAlert;
            var userName;
            var userEmail;
            var userPic;
            
            window.fbAsyncInit = function() {
                FB.init({ appId: '223110031167007', //change the appId to your appId
                    status: true, 
                    cookie: true,
                    xfbml: true,
                    oauth: true});

               function updateButton(response) {
                    button       =   document.getElementById('fb-auth');
                    userName = document.getElementById('user-name');
                    userEmail = document.getElementById('user-email');
                    userPic = document.getElementById('user-picture');
                    signInButton = document.getElementById('signInBtn');
                    signInAlert = document.getElementById('signInAlert');
                    
                    if (response.authResponse) {
                        //user is already logged in and connected
                        FB.api('/me', function(info) {
                            login(response, info);
                        });
                        
                    } else {
                        //user is not connected to your app or logged out
                        button.onclick = function() {
                            FB.login(function(response) {
                                if (response.authResponse) {
                                    FB.api('/me', function(info) {
                                        login(response, info);
                                    });	   
                                } else {
                                    //user cancelled login or did not grant authorization
                                }
                            }, {scope:'email,user_about_me'});  	
                        }
                    }
                }
                
                // run once with current status and whenever the status changes
                FB.getLoginStatus(updateButton);
                FB.Event.subscribe('auth.statusChange', updateButton);	
            };
            (function() {
                var e = document.createElement('script'); e.async = true;
                e.src = document.location.protocol 
                    + '//connect.facebook.net/en_US/all.js';
                document.getElementById('fb-root').appendChild(e);
            }());
            
            
            function login(response, info){
                if (response.authResponse) {
                    isLoggedIn = true;
                    userName.innerHTML = info.name;
                    userEmail.innerHTML = info.email;
                    userPic.innerHTML = '<img src="https://graph.facebook.com/' + info.id + '/picture">';
                    userEmail.style.display="none";
                    signInButton.style.display="none";
                    $('#myModal').modal('hide');
                    signInAlert.style.display="none";
                }
            }
        
        </script>

	<div class="navbar navbar-inverse navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container">
				<a class="btn btn-navbar" data-toggle="collapse"
					data-target=".nav-collapse"> <span class="icon-bar"></span> <span
					class="icon-bar"></span> <span class="icon-bar"></span>
				</a> <a class="brand logo" href="./codeKungfu.html">Code Kungfu</a>
				<div class="nav-collapse collapse">
					<ul class="nav">
						<li><a href="./Battle.html" class="active">Battle</a></li>
						<li><a href="./scoreboard.html">Leader Board</a></li>
					</ul>
					<ul class="nav pull-right">
						<li><a id="user-picture"></a></li>
						<li><a id="user-name"></a></li>
						<li><a id="user-email"></a></li>
						<li><a id="signInBtn" href="" data-toggle="modal" data-target="#myModal">Sign in</a></li>
					</ul>
					<!--<button type="button" class="btn btn pull-right" data-toggle="modal" data-target="#myModal">Sign in</button>-->
				</div>
				<!--/.nav-collapse -->
			</div>
		</div>
	</div>
	<!-- Modal -->
	<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog"
		aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal"
				aria-hidden="true">&times;</button>
			<h3 class="modaltemp">Sign in</h3>
		</div>
		<div class="modal-body">
			<button id="fb-auth" class="btn btn-primary">Connect with Facebook</button>
		</div>
	</div>
	
	</div>
	</div>
	<div class="container">
		<div class="span4">
			<div class="hero-unit span2">
				<h1>Battle</h1>
			</div>
			<table id="board" class="table table-bordered ttttable">
				<tr height="100px">
					<td id="0"></td>
					<td id="1"></td>
					<td id="2"></td>
				</tr>
				<tr height="100px">
					<td id="3"></td>
					<td id="4"></td>
					<td id="5"></td>
				</tr>
				<tr height="100px">
					<td id="6"></td>
					<td id="7"></td>
					<td id="8"></td>
				</tr>
			</table>
			<ul class="pager">
				<li id="previous" class="previous"><a href="#">&larr;</a></li>
				<li id="next" class="next"><a href="#">&rarr;</a></li>
			</ul>
			<div id="humanToken"></div>
			<div id="outcome"></div>
		</div>	
		<div class="span7">
		&nbsp;
			<ul class="nav nav-tabs">
				<li class="active"><a href="">Tic Tac Toe</a></li>
			</ul>
            <p id="pre-codeTxt" class="cm-s-default" style="font-family:'Lucida Console'; font-size:12">
// FUNCTION THAT MAKES A MOVE

// PARAMETERS:
// - token: player the bot is player, 'x' or 'o'
// - board: current state of the board, e.g. '****x***o' represents a board with 'x' in the center and 'o' in the bottom right corner

// RETURNS:
// - new_board: board with the new move, e.g. '****x*x*o'

function get_next_move(token, board){
            </p>
			<textarea id="codeTxt" rows="15" class="span7 playarea">
//replace this sample code with your own code!
//sample code: a dumb AI that places its token in any random spot that is empty
var retry = true;
while(retry){
  var tryPos = Math.floor(Math.random() * 9);
  if(board[tryPos] == '*'){
    new_board = board.substr(0, tryPos) + token + board.substr(tryPos + 1);
    retry = false;
  }
}
			</textarea>
			<p id="post-codeTxt" class="cm-s-default" style="font-family:'Lucida Console'; font-size:12">            
return new_board;
}
            </p>
			<br />
			<div class="pull-right">
				<button class="btn btn-success" id="submitBtn">Submit</button>
				<!--<div class="btn-group dropup">-->
					<button class="btn btn-warning" id="testBtn">Test</button>
					<!--<button class="btn dropdown-toggle btn-warning"
						data-toggle="dropdown">
						<span class="caret"></span>
					</button>
					<ul class="dropdown-menu">
						<li><a tabindex="-1" href="">Easy</a></li>
						<li><a tabindex="-1" href="">Medium</a></li>
						<li><a tabindex="-1" href="">Hard</a></li>
					</ul>
				</div>-->
				<!--<button id="reseBtn" class="btn btn-danger">Reset</button>-->
				<button class="btn" id="saveBtn">Save</button>
			</div>
		</div>
	</div>
	<!-- /container -->
	&nbsp;&nbsp;
	<div class="container">
		<div class="span1"></div>
		<div id="signInAlert" class="span9 alert">
			<button type="button" class="close" data-dismiss="alert">&times;</button>
			<strong>You are not signed in!</strong> Sign in to participate in
			tournament and have your score registered.
		</div>
	</div>
	<br />
	<div id="results"></div>
	<div class="footerblock">
		<div class="container">
			<div class="span3">
				<a class="cleanlink" target="blank" href="http://smu.edu.sg">Singapore
					Management University</a>
			</div>
			<div class="span8 pull-right"></div>
			<div class="span1 pull-right">
				<a class="cleanlink" href="./aboutus.html">About Us</a>
			</div>
		</div>
	</div>

    <!-- Scripts -->
    
    <!--[if lt IE 9]><script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script src="./scripts/jquery.js"></script>
    <script src="./scripts/bootstrap.min.js"></script>
    <script src="./scripts/codemirror/codemirror.js"></script>
    <script src="./scripts/codemirror/javascript.js"></script>
    <script src="./scripts/codemirror/runmode.js"></script>
    <script src="./scripts/codemirror/active-line.js"></script>
    <script src="./scripts/tictactoe.js"></script>
    <script type="text/javascript">
            
		//syntax highlighting
		CodeMirror.runMode($("#pre-codeTxt").html(), "text/javascript",document.getElementById("pre-codeTxt"));
		CodeMirror.runMode($("#post-codeTxt").html(), "text/javascript",document.getElementById("post-codeTxt"));
        
        //syntax highlighting on editor
        var editor = CodeMirror.fromTextArea(document.getElementById("codeTxt"), {
            lineNumbers : true,
            styleActiveLine : true,
            lineWrapping : true,
            matchBrackets : true,
            extraKeys : {
                "Enter" : "newlineAndIndentContinueComment"
            }
        });
        
        //test bot
        var testBot = function() {
            var t3 = new tictactoe();
            var results = $.parseJSON(t3.run_bot(editor.getValue()));
            displayResults(results);
        }
        
        //display results of test bot
        var displayResults = function(results){
        	
        	//display last history
        	$("#board").data('history',results.history);
        	displayHistory();
        	
        	//display outcome message
        	if(results.outcome==='-'){
                $("#outcome").html("<div class='alert alert-warning'><strong>Draw!</strong></div>");
        	}else if((results.outcome==='x' && results.x==='human') || (results.outcome==='o' && results.o==='human')){
                $("#outcome").html("<div class='alert alert-success'><strong>You Win!</strong></div>");
        	}else{
                $("#outcome").html("<div class='alert alert-danger'><strong>You Lose!</strong></div>");
        	}
        	
        	if(results.x === 'human'){
        		 $("#humanToken").html("<div class='alert alert-info center'><strong>You are X</strong></div>");
        	}else{
        		$("#humanToken").html("<div class='alert alert-info center'><strong>You are O</strong></div>");
        	}
        }
        
        //display history
        var displayHistory = function(offset){
        	//set index
        	var index;
        	if(!offset){
        		var index = $("#board").data('history').length-1; //last
                $("#board").data('index', index);
        	}else{
                var index = $("#board").data('index') + offset;
                $("#board").data('index', index);
        	}
        	
        	//display
        	var state = $("#board").data('history')[index];
        	for(var pos=0; pos<9; pos++){
                $("#"+pos).html(state[pos]==='*'?'':state[pos]);
        	}
        }
        
        //save bot
        var saveBot = function(){
            $.ajax({
            	url: '/Codefu/ttt/save',
            	type: 'post',
            	data: {
            		email: 'shiling.tai@outlook.com',    //TODO: integrate with fb log in
                    code: editor.getValue()
            	},
            	success: function(data){
            	    console.log('saved. response: ' + data);
            	}
            });
        }
        
        //submit bot for tournament
        var submitBot = function(){
            $.ajax({
                url: '/Codefu/ttt/save',
                type: 'post',
                data: {
                    email: 'shiling.tai@outlook.com',    //TODO: integrate with fb log in
                    code: editor.getValue(),
                    participate: true
                },
                success: function(data){
                    console.log('saved. response: ' + data);
                }
            });
        }
        
        //event listeners
        $("#testBtn").on('click', testBot);
        $("#previous").on('click', function(){displayHistory(-1)});
        $("#next").on('click', function(){displayHistory(1)});
        $('#saveBtn').on('click', saveBot);
        $('#submitBtn').on('click', submitBot);
        $('#resetBtn').on('click', reset);
        
        //Google Analytics
        var _gaq = _gaq || [];
        _gaq.push([ '_setAccount', 'UA-39614464-1' ]);
        _gaq.push([ '_trackPageview' ]);
    
        (function() {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl'
                    : 'http://www')
                    + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
        
    </script>	
	
</body>
</html>